{% extends 'base.html' %}
{% load static %}

{% block title %} 
    {{ product.title }} - Product Details
{% endblock %}

{% block contents %} 
<div class="page-content">
<div class="container py-5">
    <h1>{{ product.title }}</h1>
    <hr>
    <div class="row">
        <div class="col-md-6">
            <img src="{{ product.image.url }}" class="img-fluid rounded" style="max-height: 400px;" alt="{{ product.title }}">
        </div>
        <div class="col-md-6">
            <h2>Price: ${{ product.price }}</h2>
            <p>{{ product.description }}</p>
            <div class="btn-order">
              {% if in_cart %}
                <a href="#" data-id="{{product.id}}" class="canceled" onclick="ch(this)">cancele</a>
              {%else%}
                <a href="#" data-id="{{product.id}}" class="canceled" onclick="ch(this)">Order</a>
              {%endif%}
                <a href="{% url 'cart' %}">View cart</a>
            </div>
        </div>
    </div> 

<script>
      function ch(btn) {
        if(btn.className == "canceled"){
          deleteFromCart(btn)
        }else{
          AddProduct(btn)
        }
      }
      function AddProduct(btn) {
        fetch('/cart/add/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            id: btn.dataset.id,
          })
        })
          .then(response => response.json())
          .then(data => {
            btn.classList.add("canceled");
            btn.innerHTML = "Cancel";
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }


      function deleteFromCart(btn) {
        productId=btn.dataset.id
        fetch('/cart/delete/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ id: productId })
        })
          .then(res => res.json())
          .then(data => {
            btn.className=""
            btn.innerHTML = "Order";
          })
          .catch(err => console.error(err));
      }


      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
{% endblock %}